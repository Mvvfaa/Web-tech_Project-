<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Product - The Candle Co</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-cream': '#f7f5f3',
            'brand-light': '#fefcfa',
            'brand-brown': '#8b7355',
            'brand-sage': '#6b8e5a',
            'brand-sage-dark': '#5a7a4a',
            'brand-pink': '#d4a5a5',
            'brand-peach': '#f4a5a5',
            'brand-gray': '#2c2c2c',
            'brand-light-gray': '#5a5a5a',
            'brand-section': '#f2f0ed'
          },
          fontFamily: { 'serif': ['Georgia','serif'] }
        }
      }
    }
  </script>
  <style>
    .group:hover ul,.group:focus-within ul{
        opacity:1!important;
        pointer-events:auto!important
    }
    .preview{
        aspect-ratio:1/1;
        object-fit:cover
    }
    
  </style>
</head>
<body class="font-serif leading-relaxed text-brand-gray bg-brand-cream">
  <!-- Guard: no token -> redirect -->
  <script>
    (function(){
      const token = localStorage.getItem('token');
      if(!token){ window.location.href='login.html'; }
    })();
  </script>

  <header class="bg-brand-light shadow-lg sticky top-0 z-50" style="box-shadow:0 2px 10px rgba(139,115,85,.1);">
    <nav class="max-w-7xl mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
      <a href="index.html" class="flex items-center space-x-3">
        <img src="images/logo.jpg" alt="The Candle Co Logo" class="w-10 h-10 rounded-full object-cover">
        <span class="hidden sm:inline-block text-3xl font-bold text-brand-brown">The Candle Co</span>
      </a>
      <div class="flex items-center space-x-6">
        <a href="all-products.html" class="hover:text-brand-sage transition">Browse</a>
        <button id="logoutBtn" class="text-brand-sage hover:text-brand-brown transition">Logout</button>
      </div>
    </nav>
  </header>

  <section class="py-12 px-6 bg-brand-section">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
      <h1 class="text-3xl font-bold mb-6 text-brand-brown text-center">Create a Custom Product</h1>

      <div id="prodAlert" class="hidden mb-6 p-3 rounded-lg text-sm"></div>

      <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Name</label>
          <input name="name" required placeholder="e.g., Silver Tin Candle"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
        </div>

        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Display Name</label>
          <input name="displayName" placeholder="Shown on the site"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
        </div>

        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Category</label>
          <select name="category" id="categorySelect" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
            <option value="">Loading...</option>
          </select>
          <p class="text-xs text-brand-light-gray mt-1">Categories come from your backend.</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Theme</label>
          <select name="theme" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
            <option>Classic</option>
            <option>Love</option>
            <option>Motivation</option>
            <option>Ramadan</option>
            <option>Valentine</option>
            <option>Birthday</option>
            <option>Amber</option>
            <option>Cat</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Price (PKR)</label>
          <input name="price" type="number" step="0.01" min="0" required
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
        </div>

        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Stock</label>
          <input name="stock" type="number" min="0" value="0"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-brand-gray mb-2">Sizes (optional)</label>
          <input id="sizesInput" placeholder='Comma separated, e.g., Small, Medium, Large'
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
          <p class="text-xs text-brand-light-gray mt-1">Leave blank to use defaults.</p>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-brand-gray mb-2">Description</label>
          <textarea name="description" rows="4" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage"
                    placeholder="Describe the product for your customers..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-brand-gray mb-2">Design Image</label>
          <input id="imageInput" name="image" type="file" accept="image/*"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-sage">
          <p class="text-xs text-brand-light-gray mt-1">JPG/PNG/GIF up to 5MB.</p>
        </div>

        <div class="flex items-center md:justify-center">
          <img id="preview" class="preview w-40 h-40 rounded-xl border border-gray-200 object-cover hidden" alt="Preview">
        </div>

        <div class="md:col-span-2">
          <button type="submit"
                  class="w-full py-3 bg-brand-sage text-white font-bold rounded-lg hover:bg-brand-sage-dark transition">
            Create Product
          </button>
        </div>
      </form>

      <div id="resultBox" class="hidden mt-6 p-4 rounded-xl border border-green-200 bg-green-50 text-green-800 text-sm"></div>
    </div>
  </section>

  <footer class="bg-brand-brown text-white py-6 text-center">
    <p class="text-sm">&copy; 2025 CandleCo. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // Alert helpers
    const prodAlert = document.getElementById('prodAlert');
    function showAlert(msg, ok=false){
      prodAlert.textContent = msg;
      prodAlert.className = 'mb-6 p-3 rounded-lg text-sm ' + (ok ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
      prodAlert.classList.remove('hidden');
    }

    // Categories populate
    async function loadCategories() {
      try{
        const res = await fetch(API_BASE + '/categories');
        const json = await res.json();
        const sel = document.getElementById('categorySelect');
        sel.innerHTML = '';
        if(!res.ok || !json.data || !json.data.length){
          sel.innerHTML = '<option value="">No categories found</option>';
          return;
        }
        json.data.forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c._id; opt.textContent=c.name;
          sel.appendChild(opt);
        });
      }catch(e){
        const sel = document.getElementById('categorySelect');
        sel.innerHTML = '<option value="">Failed to load</option>';
      }
    }
    loadCategories();

    // Preview image
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    imageInput.addEventListener('change', ()=>{
      const f = imageInput.files?.[0];
      if(!f){ preview.classList.add('hidden'); preview.src=''; return; }
      const url = URL.createObjectURL(f);
      preview.src = url; preview.classList.remove('hidden');
    });

    // Submit form
    document.getElementById('productForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      prodAlert.classList.add('hidden');
      const formEl = e.currentTarget;
      const fd = new FormData();

      const fields = new FormData(formEl);
      for (const [k,v] of fields.entries()) {
        if (k === 'image') continue; // handle below
        fd.append(k, v);
      }

      // Sizes as repeated "sizes[]" entries
      const sizesRaw = document.getElementById('sizesInput').value.trim();
      if (sizesRaw) {
        sizesRaw.split(',').map(s=>s.trim()).filter(Boolean).forEach(s => fd.append('sizes[]', s));
      }

      // Image file
      const file = imageInput.files?.[0];
      if (file) fd.append('image', file);

      try{
        const res = await fetch(API_BASE + '/products', {
          method:'POST',
          headers:{ 'Authorization': 'Bearer ' + token }, // protected
          body: fd
        });
        const json = await res.json();
        if(!res.ok) return showAlert(json.message || 'Create failed');
        showAlert('Product created successfully!', true);
        const box = document.getElementById('resultBox');
        box.innerHTML = `
          <div class="font-semibold mb-1">Product ID: <span class="font-mono">${json.data._id}</span></div>
          ${json.data.image ? `<a class="text-brand-sage underline" target="_blank" href="${json.data.image}">View uploaded image</a>` : ''}
        `;
        box.classList.remove('hidden');
        formEl.reset();
        preview.classList.add('hidden');
      }catch(err){
        showAlert('Network error. Please try again.');
      }
    });
  </script>
</body>
</html>